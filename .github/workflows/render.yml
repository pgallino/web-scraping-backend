name: Deploy to Render (manual trigger after tests)

on:
  workflow_dispatch: {}

jobs:
  # Ejecutar Despliegue Render (Depende de Neon)
  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Trigger Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -euo pipefail
          RESP=$(curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json")
          echo "Trigger response: $RESP"
          DEPLOY_ID=$(echo "$RESP" | jq -r '.id')
          if [ -z "${DEPLOY_ID}" ] || [ "${DEPLOY_ID}" = "null" ]; then
            echo "❌ Failed to trigger deploy"; exit 1
          fi
          echo "✅ Deploy Triggered (ID: ${DEPLOY_ID})"

      - name: Health Check Public URL
        if: success()
        run: |
          set -euo pipefail
          URL="${{ secrets.RENDER_URL }}"
          # ensure no trailing slash and point to the health endpoint
          HEALTH_URL="${URL%/}/_health"
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0 Safari/537.36"
          echo "Checking ${HEALTH_URL} with User-Agent: ${UA}"
          for i in $(seq 1 12); do
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' -A "$UA" "$HEALTH_URL" || echo "000")
            echo "Attempt $i: HTTP status $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "✅ Health check passed"
              exit 0
            fi
            sleep 20
          done
          echo "❌ Health check failed after 12 attempts"
          # dump a verbose request for debugging in the workflow logs
          curl -v -A "$UA" "$HEALTH_URL" || true
          exit 1

      - name: Summary
        run: echo "✅ Render CI/CD Completed. Service is Live and Responding."